<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆåº¦æ—¶é—´åºåˆ—å¯è§†åŒ–</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“ˆ</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #fff;
            color: #222;
            font-size: 18px;
            font-weight: 400;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            font-size: 32px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .input-section input[type="month"],
        .input-section input[type="number"] {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .input-section input[type="number"] {
            width: 150px;
        }
        button {
            padding: 10px 18px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f8f8;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.2s;
        }
        button:hover {
            background: #eee;
        }
        button.primary {
            background: #4a90d9;
            color: #fff;
            border-color: #4a90d9;
        }
        button.primary:hover {
            background: #3a7fc8;
        }
        button.danger {
            color: #d9534f;
            border-color: #d9534f;
        }
        button.danger:hover {
            background: #d9534f;
            color: #fff;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        #chart {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
        }
        th, td {
            padding: 12px 14px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        td:nth-child(2), td:nth-child(3), td:nth-child(4) {
            font-weight: 600;
        }
        th {
            background: #f8f8f8;
            font-weight: 500;
        }
        tr:nth-child(even) {
            background: #fafafa;
        }
        tr:hover {
            background: #f0f0f0;
        }
        .positive {
            color: #5cb85c;
        }
        .negative {
            color: #d9534f;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .hidden {
            display: none;
        }
        #fileInput {
            display: none;
        }
        .start-month-hint {
            font-size: 14px;
            color: #444;
            font-weight: 400;
        }
        .delete-btn {
            padding: 6px 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <a href="index.html" style="text-decoration: none; color: inherit; font-size: 16px; display: flex; align-items: center; gap: 4px; color: #4a90d9;">
            â† è¿”å›é¦–é¡µ
        </a>
    </div>
    <h1>ğŸ“ˆ æœˆåº¦æ—¶é—´åºåˆ—å¯è§†åŒ–</h1>

    <div class="input-section">
        <div id="startMonthSection">
            <input type="month" id="startMonth" value="">
            <span class="start-month-hint">èµ·å§‹æœˆä»½</span>
        </div>
        <input type="number" id="valueInput" placeholder="è¾“å…¥æ•°å€¼" step="any">
        <button class="primary" onclick="addValue()">æ·»åŠ </button>
    </div>

    <div class="actions">
        <button onclick="exportJSON()">å¯¼å‡º JSON</button>
        <button onclick="document.getElementById('fileInput').click()">å¯¼å…¥ JSON</button>
        <input type="file" id="fileInput" accept=".json" onchange="importJSON(event)">
        <button class="danger" onclick="clearData()">æ¸…ç©ºæ•°æ®</button>
    </div>

    <div id="chart"></div>

    <table id="dataTable">
        <thead>
            <tr>
                <th>æœˆä»½</th>
                <th>æ•°å€¼</th>
                <th>ç¯æ¯”å˜åŒ–å€¼</th>
                <th>ç¯æ¯”å˜åŒ–ç‡</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
    </table>
    <div id="emptyState" class="empty-state">æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ ç¬¬ä¸€æ¡è®°å½•</div>

    <script>
        const STORAGE_KEY = 'timeSeriesData';
        let chart = null;
        let data = { startMonth: '', values: [] };

        function init() {
            loadData();
            chart = echarts.init(document.getElementById('chart'));
            window.addEventListener('resize', () => chart.resize());

            // è®¾ç½®é»˜è®¤èµ·å§‹æœˆä»½ä¸ºå½“å‰æœˆä»½
            const now = new Date();
            const defaultMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('startMonth').value = data.startMonth || defaultMonth;

            // å›è½¦æ·»åŠ 
            document.getElementById('valueInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addValue();
            });

            render();
        }

        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    data = JSON.parse(stored);
                } catch (e) {
                    data = { startMonth: '', values: [] };
                }
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function getMonthLabel(index) {
            if (!data.startMonth) return `ç¬¬ ${index + 1} æœŸ`;
            const [year, month] = data.startMonth.split('-').map(Number);
            const date = new Date(year, month - 1 + index);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        function calculateChangeValue(index) {
            if (index === 0) return 0;
            const prev = data.values[index - 1];
            const curr = data.values[index];
            return curr - prev;
        }

        function calculateChangeRate(index) {
            if (index === 0) return '0.00';
            if (data.values[index - 1] === 0) return null;
            const prev = data.values[index - 1];
            const curr = data.values[index];
            return ((curr - prev) / Math.abs(prev) * 100).toFixed(2);
        }

        function formatNumber(num) {
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function addValue() {
            const input = document.getElementById('valueInput');
            const value = parseFloat(input.value);
            if (isNaN(value)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼');
                return;
            }

            // ä¿å­˜èµ·å§‹æœˆä»½
            const startMonthInput = document.getElementById('startMonth');
            if (data.values.length === 0) {
                data.startMonth = startMonthInput.value;
            }

            data.values.push(value);
            saveData();
            render();
            input.value = '';
            input.focus();
        }

        function deleteValue(index) {
            if (confirm(`ç¡®å®šåˆ é™¤ ${getMonthLabel(index)} çš„æ•°æ®å—ï¼Ÿ`)) {
                data.values.splice(index, 1);
                saveData();
                render();
            }
        }

        function render() {
            renderTable();
            renderChart();

            // æœ‰æ•°æ®åéšè—èµ·å§‹æœˆä»½é€‰æ‹©
            const startMonthSection = document.getElementById('startMonthSection');
            if (data.values.length > 0) {
                startMonthSection.classList.add('hidden');
            } else {
                startMonthSection.classList.remove('hidden');
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const emptyState = document.getElementById('emptyState');
            const table = document.getElementById('dataTable');

            if (data.values.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                table.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            table.classList.remove('hidden');

            tbody.innerHTML = data.values.map((value, index) => {
                const changeValue = calculateChangeValue(index);
                const rate = calculateChangeRate(index);
                let changeDisplay = '';
                let changeClass = '';
                let rateDisplay = '-';
                let rateClass = '';
                if (index === 0) {
                    changeDisplay = '+0.00';
                    changeClass = 'positive';
                } else {
                    changeClass = changeValue >= 0 ? 'positive' : 'negative';
                    changeDisplay = `${changeValue >= 0 ? '+' : ''}${formatNumber(Math.abs(changeValue))}`;
                }
                if (rate !== null) {
                    const rateNum = parseFloat(rate);
                    rateClass = rateNum >= 0 ? 'positive' : 'negative';
                    rateDisplay = `${rateNum >= 0 ? '+' : ''}${rate}%`;
                }
                return `
                    <tr>
                        <td>${getMonthLabel(index)}</td>
                        <td>${formatNumber(value)}</td>
                        <td class="${changeClass}">${changeDisplay}</td>
                        <td class="${rateClass}">${rateDisplay}</td>
                        <td><button class="delete-btn danger" onclick="deleteValue(${index})">åˆ é™¤</button></td>
                    </tr>
                `;
            }).join('');
        }

        function renderChart() {
            if (data.values.length === 0) {
                chart.clear();
                return;
            }

            const months = data.values.map((_, i) => getMonthLabel(i));
            const rates = data.values.map((_, i) => {
                const rate = calculateChangeRate(i);
                return rate === null ? null : parseFloat(rate);
            });

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(p => {
                            const value = p.value;
                            if (value !== null && value !== undefined) {
                                const unit = p.seriesName === 'ç¯æ¯”å˜åŒ–ç‡' ? '%' : '';
                                const prefix = p.seriesName === 'ç¯æ¯”å˜åŒ–ç‡' && value >= 0 ? '+' : '';
                                const displayValue = p.seriesName === 'æ•°å€¼' ? formatNumber(value) : value;
                                result += `${p.marker} ${p.seriesName}: ${prefix}${displayValue}${unit}<br/>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['æ•°å€¼', 'ç¯æ¯”å˜åŒ–ç‡'],
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: 40,
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: months,
                    axisLabel: {
                        rotate: months.length > 12 ? 45 : 0
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'æ•°å€¼',
                        position: 'left',
                        axisLabel: {
                            formatter: function(value) {
                                return formatNumber(value);
                            }
                        }
                    },
                    {
                        type: 'value',
                        name: 'å˜åŒ–ç‡(%)',
                        position: 'right',
                        axisLabel: {
                            formatter: '{value}%'
                        }
                    }
                ],
                series: [
                    {
                        name: 'æ•°å€¼',
                        type: 'bar',
                        data: data.values,
                        itemStyle: {
                            color: '#4a90d9'
                        }
                    },
                    {
                        name: 'ç¯æ¯”å˜åŒ–ç‡',
                        type: 'line',
                        yAxisIndex: 1,
                        data: rates,
                        itemStyle: {
                            color: '#f5a623'
                        },
                        lineStyle: {
                            width: 2
                        },
                        symbol: 'circle',
                        symbolSize: 6,
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            label: { show: false },
                            lineStyle: {
                                color: '#666',
                                type: 'dashed',
                                width: 2
                            },
                            data: [
                                { yAxis: 0 }
                            ]
                        }
                    }
                ]
            };

            chart.setOption(option, true);
        }

        function exportJSON() {
            if (data.values.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `time-series-${data.startMonth || 'data'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!imported.values || !Array.isArray(imported.values)) {
                        throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                    }
                    data = {
                        startMonth: imported.startMonth || '',
                        values: imported.values.filter(v => typeof v === 'number')
                    };
                    saveData();
                    document.getElementById('startMonth').value = data.startMonth;
                    render();
                    alert('å¯¼å…¥æˆåŠŸ');
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearData() {
            if (data.values.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯æ¸…ç©º');
                return;
            }
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                data = { startMonth: '', values: [] };
                saveData();
                const now = new Date();
                document.getElementById('startMonth').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                render();
            }
        }

        init();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒç»´ç ç”Ÿæˆå™¨</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“±</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #fff;
            color: #222;
            font-size: 18px;
            font-weight: 400;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            font-size: 32px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }
        .input-section {
            margin-bottom: 20px;
        }
        .input-section textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
        }
        .input-section textarea:focus {
            outline: none;
            border-color: #4a90d9;
            box-shadow: 0 0 0 2px rgba(74, 144, 217, 0.1);
        }
        .input-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        .capacity-warning {
            color: #d9534f;
            font-weight: 500;
        }
        .capacity-ok {
            color: #5cb85c;
        }
        .templates {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .template-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f8f8;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .template-btn:hover {
            background: #eee;
        }
        .template-btn.active {
            background: #4a90d9;
            color: #fff;
            border-color: #4a90d9;
        }
        .config-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .config-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .config-label {
            font-size: 14px;
            font-weight: 500;
            color: #666;
        }
        .config-select,
        .config-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .preview-section {
            text-align: center;
            margin-bottom: 20px;
        }
        .qr-container {
            display: inline-block;
            padding: 20px;
            background: #fff;
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .qr-placeholder {
            width: 256px;
            height: 256px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 16px;
            border: 2px dashed #ddd;
            border-radius: 4px;
        }
        .actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 18px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f8f8;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }
        button:hover {
            background: #eee;
        }
        button.primary {
            background: #4a90d9;
            color: #fff;
            border-color: #4a90d9;
        }
        button.primary:hover {
            background: #3a7fc8;
        }
        button.secondary {
            background: #6c757d;
            color: #fff;
            border-color: #6c757d;
        }
        button.secondary:hover {
            background: #5a6268;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .hidden {
            display: none;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            .config-section {
                grid-template-columns: 1fr;
                padding: 16px;
            }
            .actions {
                flex-direction: column;
                align-items: stretch;
            }
            .actions button {
                width: 100%;
            }
            .templates {
                justify-content: center;
            }

        }
    </style>
</head>
<body>
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <a href="index.html" style="text-decoration: none; color: inherit; font-size: 16px; display: flex; align-items: center; gap: 4px; color: #4a90d9;">
            â† è¿”å›é¦–é¡µ
        </a>
    </div>
    <h1>ğŸ“± äºŒç»´ç ç”Ÿæˆå™¨</h1>

    <div id="alertContainer"></div>

    <div class="input-section">
        <textarea id="inputText" placeholder="è¾“å…¥è¦ç”ŸæˆäºŒç»´ç çš„æ–‡æœ¬å†…å®¹..."></textarea>
        <div class="input-info">
            <span id="charCount">å­—ç¬¦æ•°: 0</span>
            <span id="capacityHint"></span>
        </div>
        <div class="templates">
            <button class="template-btn" onclick="setTemplate('url')">URLé“¾æ¥</button>
            <button class="template-btn" onclick="setTemplate('text')">çº¯æ–‡æœ¬</button>
            <button class="template-btn" onclick="setTemplate('wifi')">WiFiç½‘ç»œ</button>
        </div>
    </div>

    <div class="config-section">
        <div class="config-group">
            <label class="config-label">äºŒç»´ç å¤§å°</label>
            <select id="qrSize" class="config-select">
                <option value="128">128px</option>
                <option value="256" selected>256px</option>
                <option value="384">384px</option>
                <option value="512">512px</option>
            </select>
        </div>
        <div class="config-group">
            <label class="config-label">å®¹é”™çº§åˆ«</label>
            <select id="errorLevel" class="config-select">
                <option value="L">L (7%)</option>
                <option value="M" selected>M (15%)</option>
                <option value="Q">Q (25%)</option>
                <option value="H">H (30%)</option>
            </select>
        </div>
        <div class="config-group">
            <label class="config-label">é¢œè‰²æ–¹æ¡ˆ</label>
            <select id="colorPreset" class="config-select">
                <option value="black">ç»å…¸é»‘ç™½</option>
                <option value="blue">å•†åŠ¡è“</option>
                <option value="green">è‡ªç„¶ç»¿</option>
                <option value="orange">æ´»åŠ›æ©™</option>
                <option value="purple">ä¼˜é›…ç´«</option>
                <option value="red">é†’ç›®çº¢</option>
            </select>
        </div>
        <div class="config-group">
            <label class="config-label">è¾¹è· (2-8px)</label>
            <input type="number" id="margin" class="config-input" min="2" max="8" value="4">
        </div>
    </div>

    <div class="preview-section">
        <div id="qrContainer" class="qr-container">
            <div id="qrPlaceholder" class="qr-placeholder">
                è¾“å…¥æ–‡æœ¬åç‚¹å‡»ç”ŸæˆäºŒç»´ç 
            </div>
        </div>
    </div>

    <div class="actions">
        <button class="primary" onclick="generateQR()">ç”ŸæˆäºŒç»´ç </button>
        <button class="secondary" onclick="downloadPNG()" disabled id="downloadBtn">ä¸‹è½½ PNG</button>
        <button class="secondary" onclick="copyBase64()" disabled id="copyBtn">å¤åˆ¶ Base64</button>
        <button class="secondary" onclick="clearLatestRecord()">æ¸…é™¤è®°å½•</button>
    </div>



    <script>
        // æ¨¡æ¿é…ç½®
        const templates = {
            url: {
                placeholder: 'https://example.com',
                description: 'ç½‘é¡µé“¾æ¥'
            },
            text: {
                placeholder: 'è¾“å…¥ä»»æ„æ–‡æœ¬å†…å®¹',
                description: 'çº¯æ–‡æœ¬'
            },
            wifi: {
                placeholder: 'WIFI:T:WPA;S:MyWiFiNetwork;P:password123;;',
                description: 'WiFiç½‘ç»œ (WIFI:æ ¼å¼)'
            }
        };

        // é¢œè‰²é¢„è®¾
        const colorPresets = {
            black: { dark: '#000000', light: '#FFFFFF' },
            blue: { dark: '#1a365d', light: '#FFFFFF' },
            green: { dark: '#2d5016', light: '#FFFFFF' },
            orange: { dark: '#9a3412', light: '#FFFFFF' },
            purple: { dark: '#581c87', light: '#FFFFFF' },
            red: { dark: '#991b1b', light: '#FFFFFF' }
        };

        // å¸¸é‡
        const STORAGE_KEY = 'latestQRCode';
        let qrCode = null;
        let currentQRData = null;

        // åˆå§‹åŒ–
        function init() {
            loadLatestQR();

            // å­—ç¬¦è®¡æ•°å’Œå®¹é‡æ£€æŸ¥
            updateCharCount();
            document.getElementById('inputText').addEventListener('input', updateCharCount);
            document.getElementById('errorLevel').addEventListener('change', updateCharCount);

            // å›è½¦ç”Ÿæˆ
            document.getElementById('inputText').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    generateQR();
                }
            });

            // å®æ—¶é¢„è§ˆï¼ˆé˜²æŠ–ï¼‰
            let debounceTimer;
            document.getElementById('inputText').addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    if (document.getElementById('inputText').value.trim()) {
                        generateQR();
                    }
                }, 500);
            });
        }

        // è®¾ç½®æ¨¡æ¿
        function setTemplate(type) {
            const textarea = document.getElementById('inputText');
            textarea.value = templates[type].placeholder;
            textarea.focus();

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // è‡ªåŠ¨ç”Ÿæˆ
            generateQR();
        }

        // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦é€‚åˆå½“å‰é…ç½®
        function canGenerateQR(text, errorLevel) {
            try {
                // äºŒç»´ç å®¹é‡é™åˆ¶ï¼ˆè¿‘ä¼¼å€¼ï¼Œå®é™…å–å†³äºå­—ç¬¦ç±»å‹ï¼‰
                const maxLengths = {
                    L: 2953, // ä½å®¹é”™ï¼Œå®¹é‡æœ€å¤§
                    M: 2331,
                    Q: 1663,
                    H: 1273  // é«˜å®¹é”™ï¼Œå®¹é‡æœ€å°
                };

                return text.length <= maxLengths[errorLevel];
            } catch (e) {
                return false;
            }
        }

        // æ›´æ–°å­—ç¬¦è®¡æ•°å’Œå®¹é‡æç¤º
        function updateCharCount() {
            const text = document.getElementById('inputText').value;
            const errorLevel = document.getElementById('errorLevel').value;

            const charCount = text.length;
            document.getElementById('charCount').textContent = `å­—ç¬¦æ•°: ${charCount}`;

            // å®¹é‡æç¤º
            const maxLengths = { L: 2953, M: 2331, Q: 1663, H: 1273 };
            const maxLength = maxLengths[errorLevel];
            const capacityHint = document.getElementById('capacityHint');

            if (charCount === 0) {
                capacityHint.textContent = '';
                capacityHint.className = '';
            } else if (charCount <= maxLength) {
                const remaining = maxLength - charCount;
                capacityHint.textContent = `è¿˜å¯è¾“å…¥${remaining}ä¸ªå­—ç¬¦`;
                capacityHint.className = 'capacity-ok';
            } else {
                const overflow = charCount - maxLength;
                capacityHint.textContent = `è¶…å‡º${overflow}ä¸ªå­—ç¬¦`;
                capacityHint.className = 'capacity-warning';
            }
        }

        // ç”ŸæˆäºŒç»´ç 
        function generateQR() {
            const text = document.getElementById('inputText').value.trim();
            if (!text) {
                showAlert('è¯·è¾“å…¥è¦ç”ŸæˆäºŒç»´ç çš„æ–‡æœ¬å†…å®¹', 'error');
                return;
            }

            const size = parseInt(document.getElementById('qrSize').value);
            const errorLevel = document.getElementById('errorLevel').value;
            const colorPreset = document.getElementById('colorPreset').value;
            const margin = parseInt(document.getElementById('margin').value);

            const colors = colorPresets[colorPreset];

            // é¢„æ£€æŸ¥å®¹é‡
            if (!canGenerateQR(text, errorLevel)) {
                const maxLengths = { L: 2953, M: 2331, Q: 1663, H: 1273 };
                const maxLength = maxLengths[errorLevel];
                showAlert(`æ–‡æœ¬è¿‡é•¿ï¼å½“å‰å®¹é”™çº§åˆ«(${errorLevel})æœ€å¤šæ”¯æŒ${maxLength}ä¸ªå­—ç¬¦ã€‚å»ºè®®ï¼šç¼©çŸ­æ–‡æœ¬æˆ–é™ä½å®¹é”™çº§åˆ«ã€‚`, 'error');
                return;
            }

            const qrContainer = document.getElementById('qrContainer');
            const placeholder = document.getElementById('qrPlaceholder');

            // å®Œå…¨æ¸…é™¤ä¹‹å‰çš„äºŒç»´ç æ˜¾ç¤º
            if (qrCode) {
                qrCode.clear();
                qrCode = null; // é‡ç½®å®ä¾‹
            }

            // æ¸…ç©ºå®¹å™¨å†…çš„æ‰€æœ‰å†…å®¹
            qrContainer.innerHTML = '';

            // é‡æ–°æ·»åŠ å ä½ç¬¦
            qrContainer.appendChild(placeholder);
            placeholder.classList.remove('hidden');

            // ç¦ç”¨å¯¼å‡ºæŒ‰é’®
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('copyBtn').disabled = true;

            try {

                // åˆ›å»ºæ–°çš„QRCodeå®ä¾‹ï¼Œä¼ å…¥å®¹å™¨å…ƒç´ 
                qrCode = new QRCode(qrContainer, {
                    text: text,
                    width: size,
                    height: size,
                    colorDark: colors.dark,
                    colorLight: colors.light,
                    correctLevel: QRCode.CorrectLevel[errorLevel]
                });

                // éšè—å ä½ç¬¦
                placeholder.classList.add('hidden');

                // å¯ç”¨å¯¼å‡ºæŒ‰é’®
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('copyBtn').disabled = false;

                // è·å–ç”Ÿæˆçš„canvasç”¨äºå¯¼å‡º
                const canvas = qrContainer.querySelector('canvas');

                // ä¿å­˜å½“å‰æ•°æ®
                currentQRData = {
                    text: text,
                    config: {
                        size: size,
                        errorLevel: errorLevel,
                        colorPreset: colorPreset,
                        margin: margin,
                        colors: colors
                    },
                    base64: canvas.toDataURL('image/png'),
                    createdAt: new Date().toISOString()
                };

                // ä¿å­˜æœ€æ–°è®°å½•
                saveLatestQR(currentQRData);

                showAlert('äºŒç»´ç ç”ŸæˆæˆåŠŸï¼', 'success');
            } catch (error) {
                let errorMessage = error.message;

                // æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                if (errorMessage.includes('code length overflow')) {
                    const maxLengths = { L: 2953, M: 2331, Q: 1663, H: 1273 };
                    const maxLength = maxLengths[errorLevel];
                    errorMessage = `æ–‡æœ¬è¿‡é•¿ï¼å½“å‰å®¹é”™çº§åˆ«(${errorLevel})æœ€å¤šæ”¯æŒ${maxLength}ä¸ªå­—ç¬¦ã€‚è¯·ç¼©çŸ­æ–‡æœ¬æˆ–é€‰æ‹©æ›´ä½çš„å®¹é”™çº§åˆ«ã€‚`;
                }

                showAlert('ç”ŸæˆäºŒç»´ç å¤±è´¥ï¼š' + errorMessage, 'error');
                placeholder.classList.remove('hidden');
                document.getElementById('downloadBtn').disabled = true;
                document.getElementById('copyBtn').disabled = true;
            }
        }

        // ä¸‹è½½PNG
        function downloadPNG() {
            if (!currentQRData) return;

            const link = document.createElement('a');
            link.download = `qrcode-${Date.now()}.png`;
            link.href = currentQRData.base64;
            link.click();
        }

        // å¤åˆ¶Base64
        function copyBase64() {
            if (!currentQRData) return;

            navigator.clipboard.writeText(currentQRData.base64).then(() => {
                showAlert('Base64ç¼–ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            }).catch(() => {
                // é™çº§æ–¹æ¡ˆï¼šåˆ›å»ºä¸´æ—¶æ–‡æœ¬æ¡†
                const textarea = document.createElement('textarea');
                textarea.value = currentQRData.base64;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showAlert('Base64ç¼–ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            });
        }

        // æœ€æ–°è®°å½•ç®¡ç†
        function loadLatestQR() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    // è‡ªåŠ¨åŠ è½½æœ€æ–°çš„è®°å½•
                    if (data.text) {
                        document.getElementById('inputText').value = data.text;
                        document.getElementById('qrSize').value = data.config.size;
                        document.getElementById('errorLevel').value = data.config.errorLevel;
                        document.getElementById('colorPreset').value = data.config.colorPreset;
                        document.getElementById('margin').value = data.config.margin;

                        // åªåœ¨æ–‡æœ¬ä¸è¶…é•¿æ—¶æ‰è‡ªåŠ¨ç”Ÿæˆ
                        const errorLevel = data.config.errorLevel;
                        if (canGenerateQR(data.text, errorLevel)) {
                            setTimeout(() => generateQR(), 100);
                        }
                    }
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯
                }
            }
        }

        function saveLatestQR(qrData) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(qrData));
        }

        function clearLatestRecord() {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('inputText').value = '';
            document.getElementById('qrContainer').innerHTML = '';
            document.getElementById('qrContainer').appendChild(document.getElementById('qrPlaceholder'));
            document.getElementById('qrPlaceholder').classList.remove('hidden');
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('copyBtn').disabled = true;
            showAlert('å·²æ¸…é™¤ä¿å­˜çš„è®°å½•', 'info');
        }

        // å·¥å…·å‡½æ•°

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;

            container.innerHTML = '';
            container.appendChild(alert);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—å™¨</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’°</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #fff;
            color: #222;
            font-size: 18px;
            font-weight: 400;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            font-size: 32px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }
        .input-section {
            margin-bottom: 20px;
        }
        .input-section__form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .input-section__group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .input-section__label {
            font-size: 14px;
            font-weight: 500;
            color: #666;
        }
        .input-section__input,
        .input-section__select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 18px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f8f8;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }
        button:hover {
            background: #eee;
        }
        button.primary {
            background: #4a90d9;
            color: #fff;
            border-color: #4a90d9;
        }
        button.primary:hover {
            background: #3a7fc8;
        }
        button.danger {
            color: #d9534f;
            border-color: #d9534f;
        }
        button.danger:hover {
            background: #d9534f;
            color: #fff;
        }
        .result-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .result-section__title {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }
        .result-section__value {
            font-size: 36px;
            font-weight: 600;
        }
        .result-section__value--positive {
            color: #5cb85c;
        }
        .result-section__value--negative {
            color: #d9534f;
        }
        .chart-section {
            margin-bottom: 20px;
        }
        #chart {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px 14px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f8f8;
            font-weight: 500;
        }
        tr:nth-child(even) {
            background: #fafafa;
        }
        tr:hover {
            background: #f0f0f0;
        }
        .positive {
            color: #5cb85c;
            font-weight: 600;
        }
        .negative {
            color: #d9534f;
            font-weight: 600;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .hidden {
            display: none;
        }
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .history-title {
            font-size: 20px;
            font-weight: 600;
        }
        .delete-btn {
            padding: 6px 10px;
            font-size: 14px;
        }
        .sort-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .sort-label {
            font-size: 14px;
            color: #666;
        }
        .sort-btn {
            padding: 6px 12px;
            font-size: 14px;
        }
        .sort-btn.active {
            background: #4a90d9;
            color: #fff;
            border-color: #4a90d9;
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            .input-section__form {
                grid-template-columns: 1fr;
                padding: 16px;
            }
            .actions {
                flex-direction: column;
            }
            .actions button {
                width: 100%;
            }
            #chart {
                height: 300px;
            }
            table {
                font-size: 14px;
            }
            th, td {
                padding: 8px 10px;
            }
            .result-section__value {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <a href="index.html" style="text-decoration: none; color: inherit; font-size: 16px; display: flex; align-items: center; gap: 4px; color: #4a90d9;">
            â† è¿”å›é¦–é¡µ
        </a>
    </div>
    <h1>ğŸ’° å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—å™¨</h1>

    <div id="alertContainer"></div>

    <div class="input-section">
        <div class="input-section__form">
            <div class="input-section__group">
                <label class="input-section__label">åŸºé‡‘åç§°</label>
                <input type="text" id="fundName" class="input-section__input" placeholder="è¾“å…¥åŸºé‡‘åç§°ï¼ˆå¯é€‰ï¼‰">
            </div>
            <div class="input-section__group">
                <label class="input-section__label">æ—¶é—´å‘¨æœŸ</label>
                <select id="period" class="input-section__select">
                    <option value="month">æœˆåº¦</option>
                    <option value="quarter">å­£åº¦</option>
                    <option value="halfYear">åŠå¹´</option>
                    <option value="year">ä¸€å¹´</option>
                </select>
            </div>
            <div class="input-section__group">
                <label class="input-section__label">åˆæœŸé‡‘é¢ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="startValue" class="input-section__input" placeholder="è¾“å…¥åˆæœŸé‡‘é¢" step="any" min="0">
            </div>
            <div class="input-section__group">
                <label class="input-section__label">æœ«æœŸé‡‘é¢ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="endValue" class="input-section__input" placeholder="è¾“å…¥æœ«æœŸé‡‘é¢" step="any" min="0">
            </div>
        </div>
        <div class="actions">
            <button class="primary" onclick="calculateAndAdd()">è®¡ç®—å¹¶æ·»åŠ </button>
            <button onclick="clearInputs()">æ¸…ç©ºè¾“å…¥</button>
        </div>
    </div>

    <div id="resultSection" class="result-section hidden">
        <div class="result-section__title">å¹´åŒ–æ”¶ç›Šç‡</div>
        <div id="resultValue" class="result-section__value"></div>
    </div>

    <div class="chart-section">
        <div id="chart"></div>
    </div>

    <div class="history-header">
        <div class="history-title">å†å²è®°å½•</div>
        <button class="danger" onclick="clearAllRecords()">æ¸…ç©ºå…¨éƒ¨</button>
    </div>

    <div class="sort-controls">
        <span class="sort-label">æ’åºæ–¹å¼ï¼š</span>
        <button class="sort-btn" onclick="sortRecords('time')" id="sortByTime">æŒ‰æ—¶é—´</button>
        <button class="sort-btn" onclick="sortRecords('return')" id="sortByReturn">æŒ‰æ”¶ç›Šç‡</button>
    </div>

    <table id="recordsTable">
        <thead>
            <tr>
                <th>åŸºé‡‘åç§°</th>
                <th>å‘¨æœŸ</th>
                <th>åˆæœŸé‡‘é¢</th>
                <th>æœ«æœŸé‡‘é¢</th>
                <th>æœŸé—´æ”¶ç›Šç‡</th>
                <th>å¹´åŒ–æ”¶ç›Šç‡</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="recordsBody">
        </tbody>
    </table>
    <div id="emptyState" class="empty-state">æš‚æ— å†å²è®°å½•ï¼Œè¯·æ·»åŠ ç¬¬ä¸€æ¡è®¡ç®—</div>

    <script>
        const STORAGE_KEY = 'annualReturnRecords';
        let chart = null;
        let records = [];
        let currentSort = 'time';

        function init() {
            loadRecords();
            chart = echarts.init(document.getElementById('chart'));
            window.addEventListener('resize', () => chart.resize());

            render();
        }

        function loadRecords() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    records = JSON.parse(stored);
                } catch (e) {
                    records = [];
                }
            }
        }

        function saveRecords() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        }

        function calculateAnnualReturn(startValue, endValue, period) {
            if (startValue <= 0) {
                throw new Error('åˆæœŸé‡‘é¢å¿…é¡»å¤§äº0');
            }
            const ratio = endValue / startValue;
            const exponents = {
                'month': 12,
                'quarter': 4,
                'halfYear': 2,
                'year': 1
            };
            return Math.pow(ratio, exponents[period]) - 1;
        }

        function calculatePeriodReturn(startValue, endValue) {
            return (endValue - startValue) / startValue;
        }

        function formatPercentage(value) {
            const percentage = (value * 100).toFixed(6);
            return percentage + '%';
        }

        function formatCurrency(value) {
            return value.toLocaleString('zh-CN', {
                minimumFractionDigits: 6,
                maximumFractionDigits: 6
            });
        }

        function formatPrecision(value, decimals = 6) {
            return value.toFixed(decimals);
        }

        function getPeriodLabel(period) {
            const labels = {
                'month': 'æœˆåº¦',
                'quarter': 'å­£åº¦',
                'halfYear': 'åŠå¹´',
                'year': 'ä¸€å¹´'
            };
            return labels[period];
        }

        function calculateAndAdd() {
            const fundName = document.getElementById('fundName').value.trim() || 'æœªå‘½ååŸºé‡‘';
            const period = document.getElementById('period').value;
            const startValue = parseFloat(document.getElementById('startValue').value);
            const endValue = parseFloat(document.getElementById('endValue').value);

            if (isNaN(startValue) || isNaN(endValue)) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢æ•°å€¼', 'error');
                return;
            }

            if (startValue <= 0) {
                showAlert('åˆæœŸé‡‘é¢å¿…é¡»å¤§äº0', 'error');
                return;
            }

            try {
                const annualReturn = calculateAnnualReturn(startValue, endValue, period);
                const periodReturn = calculatePeriodReturn(startValue, endValue);

                const record = {
                    id: Date.now(),
                    fundName: fundName,
                    period: period,
                    startValue: startValue,
                    endValue: endValue,
                    periodReturn: periodReturn,
                    annualReturn: annualReturn,
                    createdAt: new Date().toISOString()
                };

                records.push(record);
                saveRecords();
                render();
                clearInputs();
                showAlert('è®¡ç®—æˆåŠŸï¼å·²æ·»åŠ åˆ°å†å²è®°å½•', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        function clearInputs() {
            document.getElementById('fundName').value = '';
            document.getElementById('startValue').value = '';
            document.getElementById('endValue').value = '';
            document.getElementById('resultSection').classList.add('hidden');
        }

        function deleteRecord(id) {
            if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                records = records.filter(r => r.id !== id);
                saveRecords();
                render();
                showAlert('è®°å½•å·²åˆ é™¤', 'info');
            }
        }

        function clearAllRecords() {
            if (records.length === 0) {
                showAlert('æ²¡æœ‰è®°å½•å¯æ¸…ç©º', 'info');
                return;
            }
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                records = [];
                saveRecords();
                render();
                showAlert('æ‰€æœ‰è®°å½•å·²æ¸…ç©º', 'info');
            }
        }

        function sortRecords(sortBy) {
            currentSort = sortBy;

            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (sortBy === 'time') {
                document.getElementById('sortByTime').classList.add('active');
                records.sort((a, b) => b.id - a.id);
            } else if (sortBy === 'return') {
                document.getElementById('sortByReturn').classList.add('active');
                records.sort((a, b) => b.annualReturn - a.annualReturn);
            }

            saveRecords();
            render();
        }

        function render() {
            renderTable();
            renderChart();
        }

        function renderTable() {
            const tbody = document.getElementById('recordsBody');
            const emptyState = document.getElementById('emptyState');
            const table = document.getElementById('recordsTable');

            if (records.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                table.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            table.classList.remove('hidden');

            tbody.innerHTML = records.map(record => {
                const periodReturnClass = record.periodReturn >= 0 ? 'positive' : 'negative';
                const annualReturnClass = record.annualReturn >= 0 ? 'positive' : 'negative';
                const periodReturnPrefix = record.periodReturn >= 0 ? '+' : '';
                const annualReturnPrefix = record.annualReturn >= 0 ? '+' : '';

                return `
                    <tr>
                        <td>${record.fundName}</td>
                        <td>${getPeriodLabel(record.period)}</td>
                        <td>${formatCurrency(record.startValue)}</td>
                        <td>${formatCurrency(record.endValue)}</td>
                        <td class="${periodReturnClass}">${periodReturnPrefix}${formatPercentage(record.periodReturn)}</td>
                        <td class="${annualReturnClass}">${annualReturnPrefix}${formatPercentage(record.annualReturn)}</td>
                        <td><button class="delete-btn danger" onclick="deleteRecord(${record.id})">åˆ é™¤</button></td>
                    </tr>
                `;
            }).join('');
        }

        function renderChart() {
            if (records.length === 0) {
                chart.clear();
                return;
            }

            const fundNames = records.map(r => r.fundName);
            const annualReturns = records.map(r => (r.annualReturn * 100).toFixed(2));
            const colors = records.map(r => r.annualReturn >= 0 ? '#5cb85c' : '#d9534f');

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const index = params[0].dataIndex;
                        const record = records[index];
                        return `
                            ${record.fundName}<br/>
                            å‘¨æœŸï¼š${getPeriodLabel(record.period)}<br/>
                            æœŸé—´æ”¶ç›Šç‡ï¼š${formatPercentage(record.periodReturn)}<br/>
                            å¹´åŒ–æ”¶ç›Šç‡ï¼š${formatPercentage(record.annualReturn)}<br/>
                            æœŸé—´å€æ•°ï¼š${formatPrecision(record.periodReturn + 1, 6)}<br/>
                            å¹´åŒ–å€æ•°ï¼š${formatPrecision(record.annualReturn + 1, 6)}
                        `;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: 10,
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: fundNames,
                    axisLabel: {
                        rotate: records.length > 6 ? 45 : 0,
                        fontSize: 12
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '{value}%'
                    }
                },
                series: [
                    {
                        name: 'å¹´åŒ–æ”¶ç›Šç‡',
                        type: 'bar',
                        data: annualReturns,
                        itemStyle: {
                            color: function(params) {
                                return colors[params.dataIndex];
                            }
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: function(params) {
                                const value = parseFloat(params.value);
                                return (value >= 0 ? '+' : '') + formatPrecision(value, 6) + '%';
                            }
                        }
                    }
                ]
            };

            chart.setOption(option, true);
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;

            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
